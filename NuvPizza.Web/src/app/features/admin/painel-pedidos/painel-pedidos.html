<div class="painel-bg">
  @if (toast().visivel) {
  <div class="toast-container show" [ngClass]="toast().tipo">
    <i class="bi" [class.bi-check-circle-fill]="toast().tipo === 'sucesso'"
      [class.bi-info-circle-fill]="toast().tipo === 'info'" [class.bi-x-circle-fill]="toast().tipo === 'erro'"></i>
    <span>{{ toast().mensagem }}</span>
  </div>
  }

  <div class="painel-container">
    <div class="header">
      <h2>Painel de Pedidos (Cozinha)</h2>
      <div class="header-actions">
        <button (click)="abrirLoja($event)" class="btn btn-abrir"><i class="bi bi-door-open-fill"></i> Abrir
          Loja</button>
        <button (click)="fecharLoja($event)" class="btn btn-fechar"><i class="bi bi-door-closed-fill"></i> Fechar
          Loja</button>
        <button (click)="carregarPedidos()" class="btn btn-atualizar">‚Üª Atualizar</button>
      </div>
    </div>

    <!-- Status & Contagem Regressiva -->
    <div class="loja-status-bar" [class.aberta]="lojaAberta()" [class.fechada]="!lojaAberta()"
      [class.alerta]="pertoDeFecahr()">
      @if (lojaAberta()) {
      <div class="loja-status-info">
        <i class="bi bi-check-circle-fill"></i>
        <span>Loja <strong>Aberta</strong></span>
        @if (contagemRegressiva()) {
        <span class="loja-timer">‚è±Ô∏è Fecha em: <strong>{{ contagemRegressiva() }}</strong></span>
        }
      </div>
      @if (pertoDeFecahr()) {
      <button (click)="estenderHorario()" class="btn btn-estender">
        <i class="bi bi-clock-history"></i> Estender Hor√°rio
      </button>
      }
      } @else {
      <div class="loja-status-info">
        <i class="bi bi-moon-fill"></i>
        <span>Loja <strong>Fechada</strong></span>
      </div>
      }
    </div>

    <!-- Barra de Filtros -->
    <div class="filtros-bar">
      <div class="filtro-item busca">
        <i class="bi bi-search"></i>
        <input type="text" placeholder="Buscar por Nome, N¬∫ do Pedido ou Valor..." [(ngModel)]="termoBusca">
      </div>

      <div class="filtro-item">
        <label>Status:</label>
        <select [(ngModel)]="statusFiltro">
          <option value="TODOS">Todos os Pedidos</option>
          <option value="PENDENTES">Apenas Pendentes</option>
          <option value="FINALIZADOS">Apenas Finalizados</option>
          <option value="CANCELADOS">Apenas Cancelados</option>
        </select>
      </div>

      <div class="filtro-item">
        <label>Data:</label>
        <input type="date" [(ngModel)]="dataFiltro" (change)="carregarPedidos()">
      </div>

      <div class="filtro-acoes">
        <button (click)="limparFiltros()" class="btn-limpar" title="Mostrar todos os pedidos">
          <i class="bi bi-x-lg"></i> Limpar
        </button>
      </div>
    </div>

    <!-- Mensagem de Vazio se n√£o houver pedidos no filtro -->
    @if (pedidosFiltrados().length === 0) {
    <div class="empty-state">
      <i class="bi bi-inbox-fill"></i>
      <p>Nenhum pedido encontrado para estes filtros.</p>
    </div>
    }

    <div class="grid-pedidos">
      @for (pedido of pedidosFiltrados(); track pedido.id) {
      <div class="card" [ngClass]="getStatusClass(pedido.statusPedido)">
        <div class="card-header">
          <span class="pedido-id">#{{ pedido.id.substring(0,8).toUpperCase() }}</span>
          <span class="badge-status">{{ getNomeStatus(pedido.statusPedido) }}</span>
        </div>
        <div class="card-body">
          <p><strong>Cliente:</strong> {{ pedido.nomeCliente }}</p>

          <p class="mb-2">
            <i class="bi bi-wallet2"></i>
            {{ traduzirPagamento(pedido.formaPagamento) }}
          </p>

          <div class="itens-lista">
            @for (item of pedido.itens; track $index) {
            <div class="item-row">
              <span class="qtd">{{ item.quantidade }}x</span>
              <span class="prod">{{ item.nomeProduto }}</span>
            </div>
            }
          </div>

          @if (pedido.observacao) { <div class="alert-obs-mini">‚ö†Ô∏è {{ pedido.observacao }}</div> }
        </div>

        <div class="card-footer-actions">
          @if (pedido.statusPedido !== 5 && pedido.statusPedido !== 0) {
          @if (pedido.statusPedido <= 2) { <button (click)="avancarStatus(pedido)" class="btn btn-preparo w-100">üî•
            Iniciar Preparo</button>
            } @else if (pedido.statusPedido === 3) {
            <div class="row-botoes-despacho">
              <button (click)="avancarStatus(pedido)" class="btn btn-moto">üõµ Despachar</button>
              <button (click)="avisarDespachoWhatsApp(pedido)" class="btn-whatsapp" title="Avisar Despacho no WhatsApp">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path
                    d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z" />
                </svg>
              </button>
            </div>
            } @else if (pedido.statusPedido === 4) {
            <button (click)="avancarStatus(pedido)" class="btn btn-check w-100">‚úÖ Confirmar Entrega</button>
            }
            }

            @if (pedido.statusPedido === 5) { <div class="status-msg success">Pedido Conclu√≠do üéâ</div> }
            @if (pedido.statusPedido === 0) { <div class="status-msg danger">Pedido Cancelado üö´</div> }

            <button class="btn btn-detalhes w-100" (click)="verDetalhes(pedido)">
              üëÅÔ∏è Ver Detalhes
            </button>

            @if (pedido.statusPedido !== 5 && pedido.statusPedido !== 0) {
            <button (click)="cancelarPedido(pedido)" class="btn btn-cancelar-block w-100">Cancelar Pedido</button>
            }
        </div>
      </div>
      }
    </div>

    <!-- Pagina√ß√£o -->
    @if (paginacaoMeta() && paginacaoMeta()!.totalPages > 1) {
    <div class="paginacao-bar">
      <span class="paginacao-info">
        P√°gina <strong>{{ paginaAtual() }}</strong> de <strong>{{ paginacaoMeta()!.totalPages }}</strong>
        &nbsp;¬∑&nbsp; {{ paginacaoMeta()!.totalCount }} pedidos no total
      </span>
      <div class="paginacao-btns">
        <button class="pag-btn" [disabled]="!paginacaoMeta()!.hasPreviousPage" (click)="paginaAnterior()">
          <i class="bi bi-chevron-left"></i>
        </button>
        @if (paginas()[0] > 1) {
        <button class="pag-btn" (click)="irParaPagina(1)">1</button>
        @if (paginas()[0] > 2) { <span class="pag-ellipsis">‚Ä¶</span> }
        }
        @for (p of paginas(); track p) {
        <button class="pag-btn" [class.ativo]="p === paginaAtual()" (click)="irParaPagina(p)">{{ p }}</button>
        }
        @if (paginas()[paginas().length - 1] < paginacaoMeta()!.totalPages) { @if (paginas()[paginas().length - 1] <
          paginacaoMeta()!.totalPages - 1) { <span class="pag-ellipsis">‚Ä¶</span>
          }
          <button class="pag-btn" (click)="irParaPagina(paginacaoMeta()!.totalPages)">{{ paginacaoMeta()!.totalPages
            }}</button>
          }
          <button class="pag-btn" [disabled]="!paginacaoMeta()!.hasNextPage" (click)="proximaPagina()">
            <i class="bi bi-chevron-right"></i>
          </button>
      </div>
    </div>
    }

  </div>
</div>

@if (mostrarModal && pedidoSelecionado) {
<div class="modal-overlay" (click)="fecharModal()">
  <div class="modal-content-custom" (click)="$event.stopPropagation()">

    <div class="modal-custom-header" [ngClass]="getStatusClass(pedidoSelecionado.statusPedido)">
      <div>
        <h5>Pedido #{{ pedidoSelecionado.id.substring(0,8).toUpperCase() }}</h5>
        <span class="badge-modal">{{ getNomeStatus(pedidoSelecionado.statusPedido) }}</span>
      </div>
      <button class="btn-close-custom" (click)="fecharModal()">‚úñ</button>
    </div>

    <div class="modal-custom-body">
      <div class="col-itens">
        <h6 class="titulo-secao"><i class="bi bi-basket2-fill"></i> Itens do Pedido</h6>
        <ul class="lista-itens-detalhe">
          @for (item of pedidoSelecionado.itens; track $index) {
          <li>
            <div>
              <span class="badge-qtd">{{ item.quantidade }}x</span>
              <span class="nome-prod">{{ item.nomeProduto }}</span>
            </div>
            <span class="preco-prod">{{ (item.total) | currency:'BRL' }}</span>
          </li>
          }
        </ul>
        @if (pedidoSelecionado.observacao) {
        <div class="box-observacao"><strong>Obs:</strong> {{ pedidoSelecionado.observacao }}</div>
        }
        <div class="total-area">
          <span>Total Geral:</span>
          <span class="valor-total">{{ (pedidoSelecionado.valorTotal) | currency:'BRL' }}</span>
        </div>
      </div>

      <div class="col-info">
        <h6 class="titulo-secao"><i class="bi bi-geo-alt-fill"></i> Dados de Entrega</h6>

        <div class="cliente-info">
          <p class="nome-cliente">{{ pedidoSelecionado.nomeCliente }}</p>
          <p class="tel-cliente">{{ pedidoSelecionado.telefone || 'Sem telefone' }}</p>
        </div>

        <div class="endereco-box">
          <p><strong>{{ pedidoSelecionado.logradouro }}, {{ pedidoSelecionado.numero }}</strong></p>
          <p>{{ pedidoSelecionado.bairroNome }}</p>
          @if (pedidoSelecionado.complemento) { <small>Comp: {{ pedidoSelecionado.complemento }}</small> }
        </div>

        <div class="pagamento-box">
          <label>FORMA DE PAGAMENTO</label>
          <div><i class="bi bi-credit-card-2-front"></i> {{ traduzirPagamento(pedidoSelecionado.formaPagamento) }}</div>
        </div>

        <hr>

        <button (click)="imprimirComanda(pedidoSelecionado)" class="btn-imprimir">
          <i class="bi bi-printer-fill"></i> IMPRIMIR COMANDA
        </button>
        <button (click)="fecharModal()" class="btn-fechar-texto">Fechar Janela</button>
      </div>
    </div>

  </div>
</div>
}

@if (mostrarModalLoja()) {
<div class="modal-overlay" (click)="fecharModalLoja()">
  <div class="modal-content-small" (click)="$event.stopPropagation()">
    <div class="modal-custom-header" [class.status-preparo]="modalLojaTipo() === 'estender'"
      [class.status-finalizado]="modalLojaTipo() === 'abrir'" [class.status-cancelado]="modalLojaTipo() === 'fechar'">
      <h5>
        @if (modalLojaTipo() === 'abrir') { <i class="bi bi-door-open-fill"></i> Abrir Loja }
        @if (modalLojaTipo() === 'fechar') { <i class="bi bi-door-closed-fill"></i> Fechar Loja }
        @if (modalLojaTipo() === 'estender') { <i class="bi bi-clock-history"></i> Estender Hor√°rio }
      </h5>
      <button class="btn-close-custom" (click)="fecharModalLoja()">‚úñ</button>
    </div>

    <div class="modal-custom-body-p">
      @if (modalLojaTipo() === 'fechar') {
      <p class="text-center p-3">Tem certeza que deseja <strong>FECHAR</strong> a loja agora? <br> Os clientes n√£o
        conseguir√£o fazer novos pedidos.</p>
      } @else {
      <div class="form-grupo-modal">
        <label>
          @if (modalLojaTipo() === 'abrir') { Hor√°rio de encerramento (Ex: 23:59) }
          @else { Minutos para estender }
        </label>
        <input type="text" [(ngModel)]="modalLojaValor" class="input-modal-loja" placeholder="Ex: 23:59" autofocus>
      </div>
      }

      <div class="modal-acoes-loja">
        <button class="btn-cancelar-modal" (click)="fecharModalLoja()">Cancelar</button>
        <button class="btn-confirmar-modal" [class.btn-fechar]="modalLojaTipo() === 'fechar'"
          (click)="confirmarAcaoLoja()">
          Confirmar
        </button>
      </div>
    </div>
  </div>
</div>
}