<div class="checkout-bg">
  <div class="checkout-container">
    
    @if (carrinhoService.quantidadeTotal() === 0) {
      <div class="text-center">
        <button (click)="adicionarItemTeste()" class="btn-teste shadow-sm">
          üõ†Ô∏è Adicionar Pizza de Teste (Dev Mode)
        </button>
      </div>
    }

    <div class="row g-4">
      
      <div class="col-lg-7">
        <div class="card-custom h-100">
          <h2 class="mb-4"><i class="bi bi-bag-check-fill text-primary me-2"></i>Finalizar Pedido</h2>
          
          <h3 class="mt-4">1. Seus Dados</h3>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nome Completo *</label>
              <input type="text" [(ngModel)]="pedido.nomeCliente" class="form-control" placeholder="Quem vai receber?">
            </div>
            <div class="col-md-6">
              <label class="form-label">WhatsApp / Telefone *</label>
              <input type="text" [(ngModel)]="pedido.telefoneCliente" class="form-control" placeholder="(00) 00000-0000">
            </div>
          </div>

          <h3 class="mt-4">2. Entrega</h3>
          
          <div class="row g-3">
            <div class="col-md-5">
              <label class="form-label">CEP *</label>
              <div class="input-icon-group">
                <input type="text" 
                       [(ngModel)]="pedido.cep" 
                       (blur)="buscarCep()" 
                       class="form-control" 
                       placeholder="00000-000"
                       maxlength="9"
                       [disabled]="buscandoCep()">
                
                <div class="input-icon-right">
                  @if (buscandoCep()) {
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                  } @else if (pedido.logradouro) {
                    <i class="bi bi-check-circle-fill text-success"></i>
                  }
                </div>
              </div>
            </div>
            
            <div class="col-md-7">
               <label class="form-label">Bairro</label>
               <input type="text" [(ngModel)]="pedido.bairro" class="form-control input-readonly" readonly tabindex="-1">
            </div>

            <div class="col-12">
              <label class="form-label">Rua / Logradouro</label>
              <input type="text" [(ngModel)]="pedido.logradouro" class="form-control input-readonly" readonly tabindex="-1">
            </div>

            <div class="col-md-4">
              <label class="form-label">N√∫mero *</label>
              <input type="text" id="numeroInput" [(ngModel)]="pedido.numero" class="form-control" placeholder="N¬∫">
            </div>
            <div class="col-md-8">
              <label class="form-label">Complemento</label>
              <input type="text" [(ngModel)]="pedido.complemento" class="form-control" placeholder="Apt, Bloco, Ponto de ref...">
            </div>
          </div>

          <h3 class="mt-4">3. Pagamento</h3>
          
          <div class="row g-3">
            <div class="col-6">
              <div class="payment-option text-center" 
                   [class.selected]="tipoPagamento() === 'ONLINE'"
                   (click)="selecionarPagamento('ONLINE')">
                <i class="bi bi-qr-code-scan fs-2 text-primary mb-2 d-block"></i>
                <div class="fw-bold">Pagar Agora</div>
                <small class="text-muted">Pix (Aprova√ß√£o r√°pida)</small>
              </div>
            </div>

            <div class="col-6">
              <div class="payment-option text-center" 
                   [class.selected]="tipoPagamento() === 'ENTREGA'"
                   (click)="selecionarPagamento('ENTREGA')">
                <i class="bi bi-cash-stack fs-2 text-success mb-2 d-block"></i>
                <div class="fw-bold">Na Entrega</div>
                <small class="text-muted">Dinheiro ou Cart√£o</small>
              </div>
            </div>
          </div>
          
          <div class="mt-3">
             <label class="form-label">Alguma observa√ß√£o?</label>
             <textarea [(ngModel)]="pedido.observacao" class="form-control" rows="2" placeholder="Ex: Tirar cebola, campainha quebrada..."></textarea>
          </div>

        </div>
      </div>

      <div class="col-lg-5">
        <div class="card-custom sticky-top" style="top: 20px;">
          <h3 class="mb-3">Resumo do Pedido</h3>
          
          @if (carrinhoService.itens().length === 0) {
            <p class="text-muted text-center py-3">Seu carrinho est√° vazio.</p>
          } @else {
            <div class="mb-4">
              @for (item of carrinhoService.itens(); track item.id) {
                <div class="summary-item">
                   <div>
                      <span class="badge bg-light text-dark border me-2">{{ item.quantidade }}x</span>
                      <span class="fw-semibold">{{ item.nome }}</span>
                   </div>
                   <div class="fw-bold text-dark">{{ (item.preco * item.quantidade) | currency:'BRL' }}</div>
                </div>
              }
            </div>
            
            <div class="summary-item">
              <span>Subtotal</span>
              <span>{{ carrinhoService.valorTotal() | currency:'BRL' }}</span>
            </div>
            <div class="summary-item">
              <span>Taxa de Entrega</span>
              <span class="text-success">Gr√°tis</span>
            </div>

            <div class="total-row">
               <span>Total</span>
               <span class="text-primary">{{ carrinhoService.valorTotal() | currency:'BRL' }}</span>
            </div>
          }

          @if (errorMessage()) {
            <div class="alert alert-danger mt-3 d-flex align-items-center">
               <i class="bi bi-exclamation-triangle-fill me-2"></i> 
               <div>{{ errorMessage() }}</div>
            </div>
          }

          <button (click)="finalizarPedido()" [disabled]="loading() || carrinhoService.quantidadeTotal() === 0" class="btn-pagar mt-4">
            @if (loading()) {
              <span class="spinner-border spinner-border-sm me-2"></span> Processando...
            } @else {
               @if (tipoPagamento() === 'ONLINE') {
                 Pagar com Pix <i class="bi bi-arrow-right ms-2"></i>
               } @else {
                 Finalizar Pedido <i class="bi bi-check-lg ms-2"></i>
               }
            }
          </button>

          <div class="text-center mt-3">
            <small class="text-muted"><i class="bi bi-shield-lock-fill text-success"></i> Ambiente 100% Seguro</small>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>